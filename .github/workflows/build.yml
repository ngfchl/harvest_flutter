name: Build and Deploy All Dist
# è§¦å‘å·¥ä½œæµçš„æ¡ä»¶ï¼šæ‰‹åŠ¨è§¦å‘ï¼ˆworkflow_dispatchï¼‰æˆ–æ¨é€äº† tagï¼ˆä¾‹å¦‚ v1.0.0ï¼‰
on:
  workflow_dispatch:
  push:
    tags:
      - '*'  # åŒ¹é…æ‰€æœ‰ tagï¼Œä¾‹å¦‚ v1.0.0

# å®šä¹‰å¤šä¸ªâ€œä»»åŠ¡â€ï¼ˆjobsï¼‰ï¼Œæ¯ä¸ªä»»åŠ¡è¡¨ç¤ºæ„å»ºä¸€ä¸ªå¹³å°çš„åº”ç”¨
jobs:

  linux: # æ„å»º Linux æ¡Œé¢åº”ç”¨
    runs-on: ubuntu-latest
    steps:
      - name: ç­¾å‡ºä»“åº“
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: æŒ‡å®š Flutter ç‰ˆæœ¬
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.4'
      - run: |
          sudo apt-get update -y  # æ›´æ–°ç³»ç»ŸåŒ…ä¿¡æ¯
          sudo apt-get install -y \
               ninja-build \
               libgtk-3-dev \
               libasound2-dev \
               libudev-dev \
               liblzma-dev \
               clang \
               cmake \
               libmpv-dev \
               pkg-config  # å®‰è£…ä¾èµ–ï¼ˆç”¨äº Linux æ„å»ºï¼‰

      - name: å®‰è£… Flutter ä¾èµ–
        run: flutter pub get

      - name: æ‰“åŒ… Linux x64 å‘è¡Œç‰ˆ
        run: flutter build linux --release
      # - run: tar -czvf linux-x64.tar.gz -C build/linux/x64/release/bundle .  # å‹ç¼©ä¸º tar åŒ…
      - name: ç”Ÿæˆ Linux x64 å‘è¡Œç‰ˆæ–‡ä»¶å
        id: build_linux_x64  # å®šä¹‰ä¸€ä¸ªæ­¥éª¤ IDï¼Œç”¨äºåç»­å¼•ç”¨
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}')
          ARCH="x64"
          SYSTEM="linux"
          FILE_NAME="harvest_${VERSION}_${ARCH}_${SYSTEM}.tar.gz"
          tar -czvf $FILE_NAME -C build/linux/x64/release/bundle .
          echo "file_name=$FILE_NAME" >> $GITHUB_OUTPUT
          echo "app_version=${VERSION}" >> $GITHUB_OUTPUT
          ls -l $FILE_NAME
      - name: å‘å¸ƒ Linux x64 å‘è¡Œç‰ˆåˆ° GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.TOKEN_GITHUB }}
          files: ${{ github.workspace }}/${{ steps.build_linux_x64.outputs.file_name }}
          tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || github.sha }}
          name: Release ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || github.sha }}
          draft: ${{ startsWith(github.ref, 'refs/tags/') == false }}
          prerelease: false
      - name: ä¸Šä¼ åˆ°ä¸ƒç‰›äº‘
        uses: qiniu/upload-action@main
        with:
          bucket: laonie # ç©ºé—´åç§°ï¼ŒæŒ‰å®é™…æƒ…å†µå¡«å†™
          access_key: ${{ secrets.QINIU_ACCESS_KEY }} # ä¸ƒç‰›äº‘ AccessKey å¤‡æ³¨2
          secret_key: ${{ secrets.QINIU_SECRET_KEY }} # ä¸ƒç‰›äº‘ SecretKey å¤‡æ³¨2
          artifacts: ${{ steps.build_linux_x64.outputs.file_name }} # æœ¬åœ°æ–‡ä»¶å¤¹
          prefix: app/${{ steps.build_linux_x64.outputs.app_version }}/  # æ–‡ä»¶è·¯å¾„å‰ç¼€ # è¦ä¸Šä¼ åˆ°ä¸ƒç‰›äº‘ä¸­çš„æ–‡ä»¶å¤¹
          overwrite: true # æ˜¯å¦è¦†ç›–å·²æœ‰æ–‡ä»¶


  android: # æ„å»º Android åº”ç”¨
    runs-on: ubuntu-latest
    steps:
      - name: ç­¾å‡ºä»“åº“
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: è®¾ç½® Java ç¯å¢ƒ
        uses: actions/setup-java@v5  # è®¾ç½® Java ç¯å¢ƒï¼ˆAndroid ç¼–è¯‘éœ€è¦ï¼‰
        with:
          distribution: 'temurin'
          java-version: '17'
          # ğŸ‘‡ å…³é”®æ­¥éª¤ï¼šè¿˜åŸ keystore æ–‡ä»¶
      - name: è¿˜åŸ Android ä¸Šä¼  keystore æ–‡ä»¶
        run: |
          mkdir -p android/app
          echo "$KEYSTORE_BASE64" | base64 --decode > android/app/upload-keystore.jks
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          # ğŸ‘‡ ç”Ÿæˆ key.properties æ–‡ä»¶
      - name: ç”Ÿæˆ Android key.properties æ–‡ä»¶
        run: |
          cat <<EOF > android/key.properties
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=app/upload-keystore.jks
          EOF
      - name: æŒ‡å®š Flutter ç‰ˆæœ¬
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.4'
      - name: åŒæ„ Android SDK è®¸å¯è¯
        run: yes | flutter doctor --android-licenses
      - name: å®‰è£… Flutter ä¾èµ–
        run: flutter pub get
      - name: æ‰“åŒ… Android arm64 å‘è¡Œç‰ˆ
        run: flutter build apk --release --obfuscate --split-debug-info=build/symbols --split-per-abi  # æ„å»º 64 ä½ Android å®‰è£…åŒ…
      # - run: cp build/app/outputs/flutter-apk/app-release.apk android.apk
      - name: ç”Ÿæˆ Android arm64 å‘è¡Œç‰ˆæ–‡ä»¶å
        id: build_android_arm64  # å®šä¹‰ä¸€ä¸ªæ­¥éª¤ IDï¼Œç”¨äºåç»­å¼•ç”¨
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}')
          ARCH="arm64"
          SYSTEM="android"
          FILE_NAME="harvest_${VERSION}_${ARCH}-${SYSTEM}.apk"
          cp build/app/outputs/flutter-apk/app-arm64-v8a-release.apk $FILE_NAME
          echo "file_name=$FILE_NAME" >> $GITHUB_OUTPUT
          echo "app_version=${VERSION}" >> $GITHUB_OUTPUT
          ls -l $FILE_NAME
      - name: å‘å¸ƒ Android arm64 å‘è¡Œç‰ˆåˆ° GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.TOKEN_GITHUB }}
          files: ${{ github.workspace }}/${{ steps.build_android_arm64.outputs.file_name }}  # ä¸Šä¼  APK æ–‡ä»¶
          tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || github.sha }}
          name: Release ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || github.sha }}
          draft: ${{ startsWith(github.ref, 'refs/tags/') == false }}
          prerelease: false
      - name: ä¸Šä¼ åˆ°ä¸ƒç‰›äº‘
        uses: qiniu/upload-action@main
        with:
          bucket: laonie # ç©ºé—´åç§°ï¼ŒæŒ‰å®é™…æƒ…å†µå¡«å†™
          access_key: ${{ secrets.QINIU_ACCESS_KEY }} # ä¸ƒç‰›äº‘ AccessKey å¤‡æ³¨2
          secret_key: ${{ secrets.QINIU_SECRET_KEY }} # ä¸ƒç‰›äº‘ SecretKey å¤‡æ³¨2
          artifacts: ${{ steps.build_android_arm64.outputs.file_name }} # æœ¬åœ°æ–‡ä»¶å¤¹
          prefix: app/${{ steps.build_android_arm64.outputs.app_version }}/  # æ–‡ä»¶è·¯å¾„å‰ç¼€ # è¦ä¸Šä¼ åˆ°ä¸ƒç‰›äº‘ä¸­çš„æ–‡ä»¶å¤¹
          overwrite: true # æ˜¯å¦è¦†ç›–å·²æœ‰æ–‡ä»¶

  windows: # æ„å»º Windows æ¡Œé¢åº”ç”¨
    runs-on: windows-latest
    steps:
      - name: ç­¾å‡ºä»“åº“
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: æŒ‡å®š Flutter ç‰ˆæœ¬
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.4'
      - name: å®‰è£… Flutter ä¾èµ–
        run: flutter pub get
      - name: æ‰“åŒ… Windows x86 å‘è¡Œç‰ˆ
        run: flutter build windows --release
      # - run: Compress-Archive -Path build/windows/x64/runner/Release/* -DestinationPath windows-x64.zip  # å‹ç¼©ä¸º zip æ–‡ä»¶
      - name: ç”Ÿæˆ Windows x86 å‘è¡Œç‰ˆæ–‡ä»¶å
        id: build_windows_x86  # å®šä¹‰ä¸€ä¸ªæ­¥éª¤ IDï¼Œç”¨äºåç»­å¼•ç”¨
        run: |
          $versionLine = Get-Content pubspec.yaml | Where-Object { $_ -match '^version:' }
          $version = ($versionLine -split ':\s*')[1].Trim()
          $arch="x86_64"
          $FILE_NAME="harvest_${version}_${arch}-windows.zip"
          Compress-Archive -Path build/windows/x64/runner/Release/* -DestinationPath $FILE_NAME  # å‹ç¼©ä¸º zip æ–‡ä»¶
          echo "file_name=$FILE_NAME" >> $env:GITHUB_OUTPUT
          echo "app_version=$version" >> $env:GITHUB_OUTPUT
          ls -l $FILE_NAME
      - name: å‘å¸ƒ Windows x86 å‘è¡Œç‰ˆåˆ° GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.TOKEN_GITHUB }}
          files: ${{ github.workspace }}/${{ steps.build_windows_x86.outputs.file_name }}
          tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || github.sha }}
          name: Release ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || github.sha }}
          draft: ${{ startsWith(github.ref, 'refs/tags/') == false }}
          prerelease: false
      - name: ä¸Šä¼ åˆ°ä¸ƒç‰›äº‘
        uses: qiniu/upload-action@main
        with:
          bucket: laonie # ç©ºé—´åç§°ï¼ŒæŒ‰å®é™…æƒ…å†µå¡«å†™
          access_key: ${{ secrets.QINIU_ACCESS_KEY }} # ä¸ƒç‰›äº‘ AccessKey å¤‡æ³¨2
          secret_key: ${{ secrets.QINIU_SECRET_KEY }} # ä¸ƒç‰›äº‘ SecretKey å¤‡æ³¨2
          artifacts: ${{ steps.build_windows_x86.outputs.file_name }} # æœ¬åœ°æ–‡ä»¶å¤¹
          prefix: app/${{ steps.build_windows_x86.outputs.app_version }}/  # æ–‡ä»¶è·¯å¾„å‰ç¼€ # è¦ä¸Šä¼ åˆ°ä¸ƒç‰›äº‘ä¸­çš„æ–‡ä»¶å¤¹
          overwrite: true # æ˜¯å¦è¦†ç›–å·²æœ‰æ–‡ä»¶

  macos_intel: # æ„å»º macOS æ¡Œé¢åº”ç”¨
    runs-on: macos-15-intel
    steps:
      - name: ç­¾å‡ºä»“åº“
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: æŒ‡å®š Flutter ç‰ˆæœ¬
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.4'
      - name: å®‰è£… Flutter ä¾èµ–
        run: flutter pub get
      - name: æ‰“åŒ… macOS x86 å‘è¡Œç‰ˆ
        run: flutter build macos --release
      # - run: tar -czvf macos.tar.gz -C build/macos/Build/Products/Release app.app  # æ‰“åŒ…ä¸º .tar.gz
      - name: ç”Ÿæˆ macOS x86 å‘è¡Œç‰ˆæ–‡ä»¶å
        id: build_macos_x86  # å®šä¹‰ä¸€ä¸ªæ­¥éª¤ IDï¼Œç”¨äºåç»­å¼•ç”¨
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}')
          ARCH="x86_64"
          SYSTEM="macos"
          FILE_NAME="harvest_${VERSION}_${ARCH}-${SYSTEM}"
          BUILD_PATH="build/macos/Build/Products/Release/"
          APP_PATH="${BUILD_PATH}/harvest.app"
          hdiutil create -volname $FILE_NAME -srcfolder $APP_PATH -ov -format UDZO ${FILE_NAME}.dmg
          echo "file_name=$FILE_NAME" >> $GITHUB_OUTPUT
          echo "app_version=$VERSION" >> $GITHUB_OUTPUT
          ls -l $FILE_NAME.dmg
      - name: å‘å¸ƒ macOS x86 å‘è¡Œç‰ˆåˆ° GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.TOKEN_GITHUB }}
          files: ${{ github.workspace }}/${{ steps.build_macos_x86.outputs.file_name }}.dmg
          tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || github.sha }}
          name: Release ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || github.sha }}
          draft: ${{ startsWith(github.ref, 'refs/tags/') == false }}
          prerelease: false
      - name: ä¸Šä¼ åˆ°ä¸ƒç‰›äº‘
        uses: qiniu/upload-action@main
        with:
          bucket: laonie # ç©ºé—´åç§°ï¼ŒæŒ‰å®é™…æƒ…å†µå¡«å†™
          access_key: ${{ secrets.QINIU_ACCESS_KEY }} # ä¸ƒç‰›äº‘ AccessKey å¤‡æ³¨2
          secret_key: ${{ secrets.QINIU_SECRET_KEY }} # ä¸ƒç‰›äº‘ SecretKey å¤‡æ³¨2
          artifacts: ${{ steps.build_macos_x86.outputs.file_name }}.dmg # æœ¬åœ°æ–‡ä»¶å¤¹
          prefix: app/${{ steps.build_macos_x86.outputs.app_version }}/  # æ–‡ä»¶è·¯å¾„å‰ç¼€ # è¦ä¸Šä¼ åˆ°ä¸ƒç‰›äº‘ä¸­çš„æ–‡ä»¶å¤¹
          overwrite: true # æ˜¯å¦è¦†ç›–å·²æœ‰æ–‡ä»¶


  macos_arm: # æ„å»º macOS æ¡Œé¢åº”ç”¨
    runs-on: macos-latest
    steps:
      - name: ç­¾å‡ºä»“åº“
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: æŒ‡å®š Flutter ç‰ˆæœ¬
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.4'
      - name: å®‰è£… Flutter ä¾èµ–
        run: flutter pub get
      - name: æ‰“åŒ… macOS arm64 å‘è¡Œç‰ˆ
        run: flutter build macos --release
      # - run: tar -czvf macos.tar.gz -C build/macos/Build/Products/Release app.app  # æ‰“åŒ…ä¸º .tar.gz
      - name: ç”Ÿæˆ macOS arm64 å‘è¡Œç‰ˆæ–‡ä»¶å
        id: build_macos_arm  # å®šä¹‰ä¸€ä¸ªæ­¥éª¤ IDï¼Œç”¨äºåç»­å¼•ç”¨
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}')
          ARCH="arm64"
          SYSTEM="macos"
          FILE_NAME="harvest_${VERSION}_${ARCH}-${SYSTEM}"
          BUILD_PATH="build/macos/Build/Products/Release/"
          APP_PATH="${BUILD_PATH}/harvest.app"
          hdiutil create -volname $FILE_NAME -srcfolder $APP_PATH -ov -format UDZO ${FILE_NAME}.dmg
          echo "file_name=$FILE_NAME" >> $GITHUB_OUTPUT
          echo "app_version=$VERSION" >> $GITHUB_OUTPUT
          ls -l $FILE_NAME.dmg
      - name: å‘å¸ƒ macOS arm64 å‘è¡Œç‰ˆåˆ° GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.TOKEN_GITHUB }}
          files: ${{ github.workspace }}/${{ steps.build_macos_arm.outputs.file_name }}.dmg  # ä¸Šä¼  DMG æ–‡ä»¶
          tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || github.sha }}
          name: Release ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || github.sha }}
          draft: ${{ startsWith(github.ref, 'refs/tags/') == false }}
          prerelease: false
      - name: ä¸Šä¼ åˆ°ä¸ƒç‰›äº‘
        uses: qiniu/upload-action@main
        with:
          bucket: laonie # ç©ºé—´åç§°ï¼ŒæŒ‰å®é™…æƒ…å†µå¡«å†™
          access_key: ${{ secrets.QINIU_ACCESS_KEY }} # ä¸ƒç‰›äº‘ AccessKey å¤‡æ³¨2
          secret_key: ${{ secrets.QINIU_SECRET_KEY }} # ä¸ƒç‰›äº‘ SecretKey å¤‡æ³¨2
          artifacts: ${{ steps.build_macos_arm.outputs.file_name }}.dmg # æœ¬åœ°æ–‡ä»¶å¤¹
          prefix: app/${{ steps.build_macos_arm.outputs.app_version }}/  # æ–‡ä»¶è·¯å¾„å‰ç¼€ # è¦ä¸Šä¼ åˆ°ä¸ƒç‰›äº‘ä¸­çš„æ–‡ä»¶å¤¹
          overwrite: true # æ˜¯å¦è¦†ç›–å·²æœ‰æ–‡ä»¶

  ios: # æ„å»º iOS åº”ç”¨ï¼ˆéœ€è¦ macOS ç³»ç»Ÿï¼‰
    runs-on: macos-latest
    steps:
      - name: ç­¾å‡ºä»“åº“
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: æŒ‡å®š Flutter ç‰ˆæœ¬
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.4'
      - name: å®‰è£… Flutter ä¾èµ–
        run: flutter pub get
      - name: æ‰“åŒ… iOS arm64 å‘è¡Œç‰ˆ
        run: flutter build ios --release --no-codesign  # æ„å»º iOS åº”ç”¨ï¼Œä½†ä¸ç­¾åï¼ˆç”¨äºæµ‹è¯•ï¼‰
      #      - run: tar -czvf ios.tar.gz -C build/ios/iphoneos Runner.app  # å‹ç¼©æ‰“åŒ…
      - name: ç”Ÿæˆ iOS arm64 å‘è¡Œç‰ˆæ–‡ä»¶å
        id: build_ios  # å®šä¹‰ä¸€ä¸ªæ­¥éª¤ IDï¼Œç”¨äºåç»­å¼•ç”¨
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}')
          ARCH="arm64"
          SYSTEM="ios"
          FILE_NAME="harvest_${VERSION}_${ARCH}-${SYSTEM}.ipa"
          BUILD_PATH="build/ios/iphoneos"
          APP_PATH="${BUILD_PATH}/Runner.app"
          mkdir Payload
          cp -R $APP_PATH ./Payload/Runner.app
          zip -r $FILE_NAME Payload
          echo "file_name=$FILE_NAME" >> $GITHUB_OUTPUT
          echo "app_version=$VERSION" >> $GITHUB_OUTPUT
          ls -l $FILE_NAME
      - name: å‘å¸ƒ iOS arm64 å‘è¡Œç‰ˆåˆ° GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.TOKEN_GITHUB }}
          files: ${{ github.workspace }}/${{ steps.build_ios.outputs.file_name }}  # ä¸Šä¼  IPA æ–‡ä»¶
          tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || github.sha }}
          name: Release ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || github.sha }}
          draft: ${{ startsWith(github.ref, 'refs/tags/') == false }}
          prerelease: false
      - name: ä¸Šä¼ åˆ°ä¸ƒç‰›äº‘
        uses: qiniu/upload-action@main
        with:
          bucket: laonie # ç©ºé—´åç§°ï¼ŒæŒ‰å®é™…æƒ…å†µå¡«å†™
          access_key: ${{ secrets.QINIU_ACCESS_KEY }} # ä¸ƒç‰›äº‘ AccessKey å¤‡æ³¨2
          secret_key: ${{ secrets.QINIU_SECRET_KEY }} # ä¸ƒç‰›äº‘ SecretKey å¤‡æ³¨2
          artifacts: ${{ steps.build_ios.outputs.file_name }} # æœ¬åœ°æ–‡ä»¶å¤¹
          prefix: app/${{ steps.build_ios.outputs.app_version }}/  # æ–‡ä»¶è·¯å¾„å‰ç¼€ # è¦ä¸Šä¼ åˆ°ä¸ƒç‰›äº‘ä¸­çš„æ–‡ä»¶å¤¹
          overwrite: true # æ˜¯å¦è¦†ç›–å·²æœ‰æ–‡ä»¶

  web: # æ„å»º Web ç‰ˆæœ¬
    runs-on: ubuntu-latest  # ä½¿ç”¨æœ€æ–°çš„ Ubuntu ç³»ç»Ÿæ‰§è¡Œ
    needs: [ linux, android, windows, macos_intel, macos_arm, ios ]

    steps:
      - name: ç­¾å‡ºä»“åº“
        uses: actions/checkout@v6  # æ‹‰å–ä»£ç ä»“åº“
        with:
          fetch-depth: 0  # è·å–å®Œæ•´çš„æäº¤å†å²ï¼ˆç”¨äºç”Ÿæˆå˜æ›´æ—¥å¿—ç­‰ï¼‰
      - name: æŒ‡å®š Flutter ç‰ˆæœ¬
        uses: subosito/flutter-action@v2  # å®‰è£… Flutter ç¯å¢ƒ
        with:
          flutter-version: '3.32.4'
      - name: ç”Ÿæˆå‘è¡Œç‰ˆå˜æ›´æ—¥å¿—
        id: changelog
        shell: bash
        run: |
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          PREV_TAG=$(git describe --tags --abbrev=0 ${CURRENT_TAG}^ 2>/dev/null || echo "")

          echo "å½“å‰ TAG: $CURRENT_TAG"
          echo "ä¸Šä¸€ä¸ª TAG: $PREV_TAG"

          if [ -z "$PREV_TAG" ]; then
            RANGE=""
          else
            RANGE="$PREV_TAG..$CURRENT_TAG"
          fi

          # è·å–åŸå§‹ git logï¼ˆæ’é™¤ chore å’Œ mergeï¼‰
          RAW_LOG=$(git log $RANGE --pretty=format:"%H|%s" --no-merges | grep -v -E '^.*\|(chore|chore:)' || true)

          # åˆ†ç±»å­˜å‚¨
          FEAT=""
          FIX=""
          DOCS=""
          REFACTOR=""
          PERF=""
          TEST=""
          OTHER=""

          while IFS='|' read -r HASH MSG; do
            [ -z "$HASH" ] && continue

            # å¦‚æœæ˜¯ GitHub PR merge æäº¤ï¼Œè·³è¿‡ï¼ˆå·²è¢«ä¸Šæ–¹ --no-merges æ’é™¤ï¼‰
            # æŸ¥è¯¢ PR æ ‡é¢˜ï¼ˆå¦‚æœ commit æåˆ° #PR_NUMBERï¼‰
            PR_TITLE=""
            if [[ "$MSG" =~ \#([0-9]+) ]]; then
              PR_NUM="${BASH_REMATCH[1]}"
              PR_TITLE=$(gh pr view "$PR_NUM" --json title --jq '.title' 2>/dev/null || echo "")
            fi

            DISPLAY_MSG="$MSG"
            if [ -n "$PR_TITLE" ]; then
              DISPLAY_MSG="$PR_TITLE (#$PR_NUM)"
            fi

            SHORT_HASH=$(echo "$HASH" | cut -c1-7)

            if [[ "$MSG" =~ ^feat ]]; then
                FEAT+="\n- ${DISPLAY_MSG} (${SHORT_HASH})"
            elif [[ "$MSG" =~ ^fix ]]; then
                FIX+="\n- ${DISPLAY_MSG} (${SHORT_HASH})"
            elif [[ "$MSG" =~ ^docs ]]; then
                DOCS+="\n- ${DISPLAY_MSG} (${SHORT_HASH})"
            elif [[ "$MSG" =~ ^refactor ]]; then
                REFACTOR+="\n- ${DISPLAY_MSG} (${SHORT_HASH})"
            elif [[ "$MSG" =~ ^perf ]]; then
                PERF+="\n- ${DISPLAY_MSG} (${SHORT_HASH})"
            elif [[ "$MSG" =~ ^test ]]; then
                TEST+="\n- ${DISPLAY_MSG} (${SHORT_HASH})"
            else
                OTHER+="\n- ${DISPLAY_MSG} (${SHORT_HASH})"
            fi
          done <<< "$RAW_LOG"

          # ç»„åˆä¸­æ–‡æ—¥å¿—
          FINAL_LOG=""

          if [ -n "$FEAT" ]; then
            FINAL_LOG+="\n### âœ¨ æ–°å¢åŠŸèƒ½\n${FEAT}\n"
          fi
          if [ -n "$FIX" ]; then
            FINAL_LOG+="\n### ğŸ› ä¿®å¤é—®é¢˜\n${FIX}\n"
          fi
          if [ -n "$DOCS" ]; then
            FINAL_LOG+="\n### ğŸ“– æ–‡æ¡£æ›´æ–°\n${DOCS}\n"
          fi
          if [ -n "$REFACTOR" ]; then
            FINAL_LOG+="\n### ğŸ”¨ é‡æ„\n${REFACTOR}\n"
          fi
          if [ -n "$PERF" ]; then
            FINAL_LOG+="\n### âš¡ æ€§èƒ½ä¼˜åŒ–\n${PERF}\n"
          fi
          if [ -n "$TEST" ]; then
            FINAL_LOG+="\n### ğŸ§ª æµ‹è¯•ç›¸å…³\n${TEST}\n"
          fi
          if [ -n "$OTHER" ]; then
            FINAL_LOG+="\n### ğŸ“Œ å…¶ä»–å˜æ›´\n${OTHER}\n"
          fi

          # å›å†™åˆ° GitHub è¾“å‡º
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo -e "$FINAL_LOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      - name: å®‰è£… Flutter ä¾èµ–
        run: flutter pub get  # ä¸‹è½½é¡¹ç›®ä¾èµ–

      - name: æ‰“åŒ… Web å‘è¡Œç‰ˆ
        run: flutter build web --release  # æ„å»º Web ç‰ˆæœ¬çš„å‘å¸ƒåŒ…
      #      - run: tar -czvf web.tar.gz -C build/web .  # å‹ç¼©æ‰“åŒ…ä¸º web.tar.gz
      - name: ç”Ÿæˆ Web å‘è¡Œç‰ˆæ–‡ä»¶å
        id: build_web  # å®šä¹‰ä¸€ä¸ªæ­¥éª¤ IDï¼Œç”¨äºåç»­å¼•ç”¨
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}')
          ARCH="web"
          FILE_NAME="harvest_${VERSION}_${ARCH}.tar.gz"
          tar -czvf $FILE_NAME -C build/web .
          echo "file_name=$FILE_NAME" >> $GITHUB_OUTPUT
          echo "app_version=${VERSION}" >> $GITHUB_OUTPUT
          ls -l $FILE_NAME
      - name: å‘å¸ƒ Web å‘è¡Œç‰ˆåˆ° GitHub Releases
        uses: softprops/action-gh-release@v2  # å‘å¸ƒ GitHub Release
        with:
          token: ${{ secrets.TOKEN_GITHUB }}
          files: ${{ github.workspace }}/${{ steps.build_web.outputs.file_name }}  # ä¸Šä¼ æ–‡ä»¶
          tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || github.sha }}  # ä½¿ç”¨ tag æˆ–æäº¤å“ˆå¸Œå‘½å
          name: Release ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || github.sha }}
          draft: ${{ startsWith(github.ref, 'refs/tags/') == false }}  # å¦‚æœä¸æ˜¯ tagï¼Œä½œä¸ºè‰ç¨¿
          prerelease: false  # ä¸æ ‡è®°ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
          body: |
            ## ğŸ“Œ æ›´æ–°æ—¥å¿—
            ${{ steps.changelog.outputs.changelog }}
      - name: ä¸Šä¼ åˆ°ä¸ƒç‰›äº‘
        uses: qiniu/upload-action@main
        with:
          bucket: laonie # ç©ºé—´åç§°ï¼ŒæŒ‰å®é™…æƒ…å†µå¡«å†™
          access_key: ${{ secrets.QINIU_ACCESS_KEY }} # ä¸ƒç‰›äº‘ AccessKey å¤‡æ³¨2
          secret_key: ${{ secrets.QINIU_SECRET_KEY }} # ä¸ƒç‰›äº‘ SecretKey å¤‡æ³¨2
          artifacts: ${{ steps.build_web.outputs.file_name }} # æœ¬åœ°æ–‡ä»¶å¤¹
          prefix: app/${{ steps.build_web.outputs.app_version }}/ # è¦ä¸Šä¼ åˆ°ä¸ƒç‰›äº‘ä¸­çš„æ–‡ä»¶å¤¹
          overwrite: true # æ˜¯å¦è¦†ç›–å·²æœ‰æ–‡ä»¶
      - name: ç”Ÿæˆé“¾æ¥å¹¶å‘å¸ƒåˆ° Repeat Publish API
        id: gen_links
        run: |
          CHANGELOG="${{ needs.changelog.outputs.changelog }}"
          PUBLISH_URL="https://repeat.ptools.fun/api/app/upload"
          TOKEN="${{ secrets.HARVEST_TOKEN }}"
          EMAIL="${{ secrets.HARVEST_EMAIL }}"
          VERSION="${{ steps.build_web.outputs.app_version }}"
          BASE_URL="http://file.ptools.fun/app/$VERSION"
          # ä½¿ç”¨ jq è‡ªåŠ¨æ„å»º links JSON
          LINKS_JSON=$(jq -n --arg v "$VERSION" --arg base "$BASE_URL" '
          {
            # Linux
            ("harvest_\($v)_x64_linux.tar.gz"): "\($base)/harvest_\($v)_x64_linux.tar.gz",
            # ("harvest_\($v)_arm64_linux.tar.gz"): "\($base)/harvest_\($v)_arm64_linux.tar.gz",
          
            # Android
            # ("harvest_\($v)_arm32-android.apk"): "\($base)/harvest_\($v)_arm32-android.apk",
            ("harvest_\($v)_arm64-android.apk"): "\($base)/harvest_\($v)_arm64-android.apk",
            # ("harvest_\($v)_x86_64-android.apk"): "\($base)/harvest_\($v)_x86_64-android.apk",
          
            # Windows
            ("harvest_\($v)_x86_64-windows.zip"): "\($base)/harvest_\($v)_x86_64-windows.zip",
          
            # macOS
            ("harvest_\($v)_x86_64-macos.dmg"): "\($base)/harvest_\($v)_x86_64-macos.dmg",
            ("harvest_\($v)_arm64-macos.dmg"): "\($base)/harvest_\($v)_arm64-macos.dmg",
          
            # iOS
            ("harvest_\($v)_arm64-ios.ipa"): "\($base)/harvest_\($v)_arm64-ios.ipa",
          
            # Web
            ("harvest_\($v)_web.tar.gz"): "\($base)/harvest_\($v)_web.tar.gz"
          }
          ')
          
          echo "ç”Ÿæˆçš„ä¸‹è½½é“¾æ¥ JSON:"
          echo "$LINKS_JSON"
          
          # â¬…â¬…â¬…â¬…â¬… å…³é”®ç‚¹ï¼šlinks éœ€è¦å˜æˆå­—ç¬¦ä¸²ï¼Œè€Œä¸æ˜¯å¯¹è±¡
          LINKS_STRING=$(jq -n --argjson links "$LINKS_JSON" '$links | @json')
          echo "LINKS_STRING: $LINKS_STRING"  
          # æ„å»ºæœ€ç»ˆè¯·æ±‚ JSON
          REQUEST_JSON=$(jq -n \
            --arg version "$VERSION" \
            --arg changelog "$CHANGELOG" \
            --arg links "$LINKS_JSON" \
            '
          {
            version: $version,
            changelog: $changelog,
            downloadLinks: $links
          }
          ')
          
          echo "è¯·æ±‚ JSON:"
          echo "$REQUEST_JSON"
          
          # å‘é€å‘å¸ƒè¯·æ±‚
          curl -X POST "$PUBLISH_URL" \
          -H "Authorization: $TOKEN" \
          -H "EMAIL: $EMAIL" \
          -H "Content-Type: application/json" \
          -d "$REQUEST_JSON"